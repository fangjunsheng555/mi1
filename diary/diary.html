<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>蜜语日记 🌸</title>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>
  <style>
    body { position:relative; overflow-x:hidden; font-family:'ZCOOL KuaiLe',cursive; background:linear-gradient(135deg,#ffe4ec,#fff0f5,#fce4ec,#f3e5f5); background-size:400% 400%; animation:gradientBG 12s ease infinite; padding:20px; max-width:600px; margin:auto; color:#a0005b; text-align:center;}
    @keyframes gradientBG {0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;}}
    textarea,select,input,button {width:100%; box-sizing:border-box; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid #ccc; font-family:inherit; font-size:16px;}
    button {background-color:#ff69b4; color:white; border:none; cursor:pointer; transition:transform .2s;}
    button:active {transform:scale(0.95);}
    .diary-entry {background:white; border-radius:10px; padding:12px; margin-top:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:left; margin-bottom:20px;}
    .diary-entry div {margin-bottom:18px;}
    .media-container {display:flex; flex-wrap:wrap; justify-content:flex-start; gap:10px; margin-bottom:20px;}
    .media-container img {max-width:22%; cursor:pointer; transition:transform 0.2s; margin-bottom:12px;}
    .media-container img:hover {transform:scale(1.1);}
    .meta-info {font-size:14px; color:#888; margin-top:8px;}
    .like-btn { background: #fff0f5; color: #e84393; border: 1px solid #f5b0d7; padding: 6px 18px; border-radius: 18px; font-size: 16px; margin-right: 12px;}
    .like-btn.liked { color:#fff; background:#e84393; }
    .comments { margin-top:8px; background:#f8f8fa; border-radius:8px; padding:8px; }
    .comment-content { font-size:15px; color:#e84393; margin-bottom:6px;}
    .comment-time { font-size:13px; color:#aaa; margin-bottom:3px;}
    .comment-form { display:flex; gap:8px; margin-top:8px;}
    .comment-form input {flex:1; padding:5px; font-size:15px;}
    .comment-form button {padding:5px 12px; font-size:15px;}
    #lightbox {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000;}
    #lightbox img {max-width:90%; max-height:90%;}
  </style>
</head>
<body>
  <h2>🌸 蜜语日记 🌸</h2>
  <label for="bgmSelect">选择背景音乐：</label>
  <select id="bgmSelect" onchange="changeBgm()">
    <option value="浪漫手机.mp3">浪漫手机</option>
    <option value="可爱女人.mp3">可爱女人</option>
    <option value="园游会.mp3">园游会</option>
  </select>
  <button onclick="toggleBgm()">点击播放/暂停音乐</button>
  <audio id="bgm" loop></audio>
  <input type="text" id="location" readonly placeholder="定位：获取中…">
  <input type="password" id="password" placeholder="请输入密码（蜜儿我们认识的年月日）" />
  <textarea id="diaryContent" rows="4" placeholder="今天想记录些什么呢？"></textarea>
  <select id="mood">
    <option>😊 开心</option>
    <option>😢 难过</option>
    <option>🥰 甜蜜</option>
    <option>😡 生气</option>
    <option>😐 一般</option>
  </select>
  <input type="file" id="media" accept="image/*,video/*" multiple>
  <button onclick="submitDiary()">发表日记 🌸</button>
  <div id="historyTitle">📜 历史日记</div>
  <div id="diaryList"></div>
  <div id="lightbox" onclick="closeLightbox()">
    <img src="" alt="放大图" />
  </div>
<script>
AV.init({
  appId: 'bxR762L3dDWFiyX2u7nsxLHV-gzGzoHsz',
  appKey: 'uVCOuieZ3JnX7zH8BQdLSzoF',
  serverURL: 'https://bxr762l3.lc-cn-n1-shared.com'
});
// 获取IP定位
async function getLocationFromIP() {
  try {
    const res = await fetch('https://ipapi.co/json/');
    const data = await res.json();
    const city = data.city || '未知城市';
    document.getElementById('location').value = '定位：' + city;
    return city;
  } catch (error) {
    document.getElementById('location').value = '定位：获取失败';
    return '未知城市';
  }
}
let currentCity = '未知城市';
getLocationFromIP().then(city => currentCity = city);

// 音乐播放部分
function toggleBgm() {
  const bgm = document.getElementById('bgm');
  if(bgm.paused){ bgm.play(); } else { bgm.pause(); }
}
function changeBgm() {
  const selected = document.getElementById('bgmSelect').value;
  const bgm = document.getElementById('bgm');
  let wasPlaying = !bgm.paused;
  bgm.src = selected;
  if(wasPlaying){ bgm.play(); }
}
// 提交日记
async function submitDiary() {
  const password = document.getElementById('password').value;
  const correctPassword = '200211';
  if(password !== correctPassword) return alert('密码错误！请重新输入');
  const content = document.getElementById('diaryContent').value.trim();
  const mood = document.getElementById('mood').value;
  const city = currentCity;
  const files = document.getElementById('media').files;
  if(!content) return alert('先写点内容吧～');
  const Diary = AV.Object.extend('Diary');
  const diary = new Diary();
  diary.set('content', content); diary.set('mood', mood); diary.set('location', city);
  const acl = new AV.ACL(); acl.setPublicReadAccess(true); diary.setACL(acl);
  // 初始化点赞数为0
  diary.set('likes', 0);
  // 上传媒体
  if(files.length){
    const uploads = Array.from(files).map(f=> (new AV.File(f.name, f)).save());
    const saved = await Promise.all(uploads);
    diary.set('mediaFiles', saved.map(f=>({url:f.url(),type:f.attributes.mime_type})));
  }
  diary.save().then(()=>{ alert('日记发表成功！'); document.getElementById('diaryContent').value = ''; document.getElementById('media').value = ''; loadDiaries();})
  .catch(e=>alert('保存失败：'+e.message));
}

// 加载历史日记
async function loadDiaries() {
  const Diary = AV.Object.extend('Diary');
  const q = new AV.Query(Diary);
  q.descending('createdAt');
  q.limit(20);
  const results = await q.find();
  const diaryListDiv = document.getElementById('diaryList');
  diaryListDiv.innerHTML = '';
  for (const d of results) {
    const content = d.get('content');
    const mood = d.get('mood');
    const city = d.get('location');
    const date = d.createdAt.toLocaleString();
    const media = d.get('mediaFiles') || [];
    const likes = d.get('likes') || 0;
    const diaryId = d.id;
    // 构建媒体html
    let mediaHtml = '';
    if(media.length){
      mediaHtml = `<div class="media-container">`;
      media.forEach(f=>{
        mediaHtml += f.type.startsWith('image') ?
          `<img src="${f.url}" onclick="openLightbox('${f.url}')">`
          : `<video src="${f.url}" controls style="max-width:100%;max-height:120px;"></video>`;
      });
      mediaHtml += `</div>`;
    }
    // 评论数据
    const comments = await getCommentsForDiary(diaryId);
    let commentsHtml = '';
    if(comments.length){
      commentsHtml += comments.map(c=>
        `<div class="comment-content">${escapeHtml(c.content)}</div>
         <div class="comment-time">${c.time}</div>`
      ).join('');
    } else {
      commentsHtml += `<div class="comment-time" style="color:#bbb">暂无评论</div>`;
    }
    // 日记整体HTML
    diaryListDiv.insertAdjacentHTML('beforeend',`
      <div class="diary-entry" data-id="${diaryId}">
        <div>${escapeHtml(content)}</div>
        ${mediaHtml}
        <div class="meta-info">${escapeHtml(mood)} | ${escapeHtml(city)} | ${date}</div>
        <button class="like-btn" onclick="likeDiary('${diaryId}', this)"><span>👍</span> <span class="like-count">${likes}</span></button>
        <div class="comments">
          <b style="font-size:15px;">评论</b>
          ${commentsHtml}
          <form class="comment-form" onsubmit="return submitComment('${diaryId}', this)">
            <input type="text" placeholder="写点什么..." maxlength="100" required>
            <button type="submit">发送</button>
          </form>
        </div>
      </div>
    `);
  }
}
// 防止XSS
function escapeHtml(str){
  return (str||'').replace(/[<>"'&]/g, s=>({"<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","&":"&amp;"}[s]));
}
// 获取评论
async function getCommentsForDiary(diaryId){
  const Comment = AV.Object.extend('Comment');
  const q = new AV.Query(Comment);
  q.equalTo('diaryId', diaryId);
  q.ascending('createdAt');
  const res = await q.find();
  return res.map(c=>({content:c.get('content'),time:c.createdAt.toLocaleString()}));
}
// 提交评论
async function submitComment(diaryId, form){
  const input = form.querySelector('input');
  const val = input.value.trim();
  if(!val) return false;
  const Comment = AV.Object.extend('Comment');
  const c = new Comment();
  c.set('diaryId', diaryId);
  c.set('content', val);
  await c.save();
  input.value = '';
  loadDiaries(); // 重新加载刷新
  return false; // 阻止表单提交刷新
}
// 点赞功能
async function likeDiary(diaryId, btn){
  btn.disabled = true;
  const Diary = AV.Object.extend('Diary');
  const q = new AV.Query(Diary);
  const d = await q.get(diaryId);
  let likes = d.get('likes')||0;
  likes++;
  d.set('likes', likes);
  await d.save();
  btn.querySelector('.like-count').innerText = likes;
  btn.classList.add('liked');
  btn.disabled = false;
}

// 放大图片
function openLightbox(imageUrl) {
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = lightbox.querySelector('img');
  lightboxImage.src = imageUrl;
  lightbox.style.display = 'flex';
}
function closeLightbox() {
  document.getElementById('lightbox').style.display = 'none';
}
window.onload = function() {
  changeBgm();
  loadDiaries();
  // 允许音乐自动播放（需首次点击）
  document.body.addEventListener('click', ()=>{
    document.getElementById('bgm').play().catch(()=>{});
  }, {once:true});
};
</script>
</body>
</html>
