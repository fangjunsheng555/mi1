<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>èœœè¯­æ—¥è®° ğŸŒ¸</title>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>
  <style>
    body { position:relative; overflow-x:hidden; font-family:'ZCOOL KuaiLe',cursive; background:linear-gradient(135deg,#ffe4ec,#fff0f5,#fce4ec,#f3e5f5); background-size:400% 400%; animation:gradientBG 12s ease infinite; padding:20px; max-width:600px; margin:auto; color:#a0005b; text-align:center;}
    @keyframes gradientBG {0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;}}
    textarea,select,input,button {width:100%; box-sizing:border-box; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid #ccc; font-family:inherit; font-size:16px;}
    button {background-color:#ff69b4; color:white; border:none; cursor:pointer; transition:transform .2s;}
    button:active {transform:scale(0.95);}
    .diary-entry {background:white; border-radius:10px; padding:12px; margin-top:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:left; margin-bottom:20px;}
    .diary-entry div {margin-bottom:18px;}
    .media-container {display:flex; flex-wrap:wrap; justify-content:flex-start; gap:10px; margin-bottom:20px;}
    .media-container img {max-width:22%; cursor:pointer; transition:transform 0.2s; margin-bottom:12px;}
    .media-container img:hover {transform:scale(1.1);}
    .meta-info {font-size:14px; color:#888; margin-top:8px;}
    .like-btn { background: #fff0f5; color: #e84393; border: 1px solid #f5b0d7; padding: 6px 18px; border-radius: 18px; font-size: 16px; margin-right: 12px;}
    .like-btn.liked { color:#fff; background:#e84393; }
    .comments { margin-top:8px; background:#f8f8fa; border-radius:8px; padding:8px; }
    .comment-content { font-size:15px; color:#e84393; margin-bottom:6px;}
    .comment-time { font-size:13px; color:#aaa; margin-bottom:3px;}
    .comment-form { display:flex; gap:8px; margin-top:8px;}
    .comment-form input {flex:1; padding:5px; font-size:15px;}
    .comment-form button {padding:5px 12px; font-size:15px;}
    #lightbox {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000;}
    #lightbox img {max-width:90%; max-height:90%;}
  </style>
</head>
<body>
  <h2>ğŸŒ¸ èœœè¯­æ—¥è®° ğŸŒ¸</h2>
  <label for="bgmSelect">é€‰æ‹©èƒŒæ™¯éŸ³ä¹ï¼š</label>
  <select id="bgmSelect" onchange="changeBgm()">
    <option value="æµªæ¼«æ‰‹æœº.mp3">æµªæ¼«æ‰‹æœº</option>
    <option value="å¯çˆ±å¥³äºº.mp3">å¯çˆ±å¥³äºº</option>
    <option value="å›­æ¸¸ä¼š.mp3">å›­æ¸¸ä¼š</option>
  </select>
  <button onclick="toggleBgm()">ç‚¹å‡»æ’­æ”¾/æš‚åœéŸ³ä¹</button>
  <audio id="bgm" loop></audio>
  <input type="text" id="location" readonly placeholder="å®šä½ï¼šè·å–ä¸­â€¦">
  <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆèœœå„¿æˆ‘ä»¬è®¤è¯†çš„å¹´æœˆæ—¥ï¼‰" />
  <textarea id="diaryContent" rows="4" placeholder="ä»Šå¤©æƒ³è®°å½•äº›ä»€ä¹ˆå‘¢ï¼Ÿ"></textarea>
  <select id="mood">
    <option>ğŸ˜Š å¼€å¿ƒ</option>
    <option>ğŸ˜¢ éš¾è¿‡</option>
    <option>ğŸ¥° ç”œèœœ</option>
    <option>ğŸ˜¡ ç”Ÿæ°”</option>
    <option>ğŸ˜ ä¸€èˆ¬</option>
  </select>
  <input type="file" id="media" accept="image/*,video/*" multiple>
  <button onclick="submitDiary()">å‘è¡¨æ—¥è®° ğŸŒ¸</button>
  <div id="historyTitle">ğŸ“œ å†å²æ—¥è®°</div>
  <div id="diaryList"></div>
  <div id="lightbox" onclick="closeLightbox()">
    <img src="" alt="æ”¾å¤§å›¾" />
  </div>
<script>
AV.init({
  appId: 'bxR762L3dDWFiyX2u7nsxLHV-gzGzoHsz',
  appKey: 'uVCOuieZ3JnX7zH8BQdLSzoF',
  serverURL: 'https://bxr762l3.lc-cn-n1-shared.com'
});
// è·å–IPå®šä½
async function getLocationFromIP() {
  try {
    const res = await fetch('https://ipapi.co/json/');
    const data = await res.json();
    const city = data.city || 'æœªçŸ¥åŸå¸‚';
    document.getElementById('location').value = 'å®šä½ï¼š' + city;
    return city;
  } catch (error) {
    document.getElementById('location').value = 'å®šä½ï¼šè·å–å¤±è´¥';
    return 'æœªçŸ¥åŸå¸‚';
  }
}
let currentCity = 'æœªçŸ¥åŸå¸‚';
getLocationFromIP().then(city => currentCity = city);

// éŸ³ä¹æ’­æ”¾éƒ¨åˆ†
function toggleBgm() {
  const bgm = document.getElementById('bgm');
  if(bgm.paused){ bgm.play(); } else { bgm.pause(); }
}
function changeBgm() {
  const selected = document.getElementById('bgmSelect').value;
  const bgm = document.getElementById('bgm');
  let wasPlaying = !bgm.paused;
  bgm.src = selected;
  if(wasPlaying){ bgm.play(); }
}
// æäº¤æ—¥è®°
async function submitDiary() {
  const password = document.getElementById('password').value;
  const correctPassword = '200211';
  if(password !== correctPassword) return alert('å¯†ç é”™è¯¯ï¼è¯·é‡æ–°è¾“å…¥');
  const content = document.getElementById('diaryContent').value.trim();
  const mood = document.getElementById('mood').value;
  const city = currentCity;
  const files = document.getElementById('media').files;
  if(!content) return alert('å…ˆå†™ç‚¹å†…å®¹å§ï½');
  const Diary = AV.Object.extend('Diary');
  const diary = new Diary();
  diary.set('content', content); diary.set('mood', mood); diary.set('location', city);
  const acl = new AV.ACL(); acl.setPublicReadAccess(true); diary.setACL(acl);
  // åˆå§‹åŒ–ç‚¹èµæ•°ä¸º0
  diary.set('likes', 0);
  // ä¸Šä¼ åª’ä½“
  if(files.length){
    const uploads = Array.from(files).map(f=> (new AV.File(f.name, f)).save());
    const saved = await Promise.all(uploads);
    diary.set('mediaFiles', saved.map(f=>({url:f.url(),type:f.attributes.mime_type})));
  }
  diary.save().then(()=>{ alert('æ—¥è®°å‘è¡¨æˆåŠŸï¼'); document.getElementById('diaryContent').value = ''; document.getElementById('media').value = ''; loadDiaries();})
  .catch(e=>alert('ä¿å­˜å¤±è´¥ï¼š'+e.message));
}

// åŠ è½½å†å²æ—¥è®°
async function loadDiaries() {
  const Diary = AV.Object.extend('Diary');
  const q = new AV.Query(Diary);
  q.descending('createdAt');
  q.limit(20);
  const results = await q.find();
  const diaryListDiv = document.getElementById('diaryList');
  diaryListDiv.innerHTML = '';
  for (const d of results) {
    const content = d.get('content');
    const mood = d.get('mood');
    const city = d.get('location');
    const date = d.createdAt.toLocaleString();
    const media = d.get('mediaFiles') || [];
    const likes = d.get('likes') || 0;
    const diaryId = d.id;
    // æ„å»ºåª’ä½“html
    let mediaHtml = '';
    if(media.length){
      mediaHtml = `<div class="media-container">`;
      media.forEach(f=>{
        mediaHtml += f.type.startsWith('image') ?
          `<img src="${f.url}" onclick="openLightbox('${f.url}')">`
          : `<video src="${f.url}" controls style="max-width:100%;max-height:120px;"></video>`;
      });
      mediaHtml += `</div>`;
    }
    // è¯„è®ºæ•°æ®
    const comments = await getCommentsForDiary(diaryId);
    let commentsHtml = '';
    if(comments.length){
      commentsHtml += comments.map(c=>
        `<div class="comment-content">${escapeHtml(c.content)}</div>
         <div class="comment-time">${c.time}</div>`
      ).join('');
    } else {
      commentsHtml += `<div class="comment-time" style="color:#bbb">æš‚æ— è¯„è®º</div>`;
    }
    // æ—¥è®°æ•´ä½“HTML
    diaryListDiv.insertAdjacentHTML('beforeend',`
      <div class="diary-entry" data-id="${diaryId}">
        <div>${escapeHtml(content)}</div>
        ${mediaHtml}
        <div class="meta-info">${escapeHtml(mood)} | ${escapeHtml(city)} | ${date}</div>
        <button class="like-btn" onclick="likeDiary('${diaryId}', this)"><span>ğŸ‘</span> <span class="like-count">${likes}</span></button>
        <div class="comments">
          <b style="font-size:15px;">è¯„è®º</b>
          ${commentsHtml}
          <form class="comment-form" onsubmit="return submitComment('${diaryId}', this)">
            <input type="text" placeholder="å†™ç‚¹ä»€ä¹ˆ..." maxlength="100" required>
            <button type="submit">å‘é€</button>
          </form>
        </div>
      </div>
    `);
  }
}
// é˜²æ­¢XSS
function escapeHtml(str){
  return (str||'').replace(/[<>"'&]/g, s=>({"<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","&":"&amp;"}[s]));
}
// è·å–è¯„è®º
async function getCommentsForDiary(diaryId){
  const Comment = AV.Object.extend('Comment');
  const q = new AV.Query(Comment);
  q.equalTo('diaryId', diaryId);
  q.ascending('createdAt');
  const res = await q.find();
  return res.map(c=>({content:c.get('content'),time:c.createdAt.toLocaleString()}));
}
// æäº¤è¯„è®º
async function submitComment(diaryId, form){
  const input = form.querySelector('input');
  const val = input.value.trim();
  if(!val) return false;
  const Comment = AV.Object.extend('Comment');
  const c = new Comment();
  c.set('diaryId', diaryId);
  c.set('content', val);
  await c.save();
  input.value = '';
  loadDiaries(); // é‡æ–°åŠ è½½åˆ·æ–°
  return false; // é˜»æ­¢è¡¨å•æäº¤åˆ·æ–°
}
// ç‚¹èµåŠŸèƒ½
async function likeDiary(diaryId, btn){
  btn.disabled = true;
  const Diary = AV.Object.extend('Diary');
  const q = new AV.Query(Diary);
  const d = await q.get(diaryId);
  let likes = d.get('likes')||0;
  likes++;
  d.set('likes', likes);
  await d.save();
  btn.querySelector('.like-count').innerText = likes;
  btn.classList.add('liked');
  btn.disabled = false;
}

// æ”¾å¤§å›¾ç‰‡
function openLightbox(imageUrl) {
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = lightbox.querySelector('img');
  lightboxImage.src = imageUrl;
  lightbox.style.display = 'flex';
}
function closeLightbox() {
  document.getElementById('lightbox').style.display = 'none';
}
window.onload = function() {
  changeBgm();
  loadDiaries();
  // å…è®¸éŸ³ä¹è‡ªåŠ¨æ’­æ”¾ï¼ˆéœ€é¦–æ¬¡ç‚¹å‡»ï¼‰
  document.body.addEventListener('click', ()=>{
    document.getElementById('bgm').play().catch(()=>{});
  }, {once:true});
};
</script>
</body>
</html>
