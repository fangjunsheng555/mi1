<script>
  // LeanCloud初始化
  AV.init({
    appId: 'bxR762L3dDWFiyX2u7nsxLHV-gzGzoHsz',
    appKey: 'uVCOuieZ3JnX7zH8BQdLSzoF',
    serverURL: 'https://bxr762l3.lc-cn-n1-shared.com'
  });

  // IP定位
  async function getLocationFromIP() {
    try {
      const response = await fetch('https://ipapi.co/json/');
      const data = await response.json();
      const city = data.city || '未知城市';
      document.getElementById('location').value = '定位：' + city;
      return city;
    } catch (error) {
      document.getElementById('location').value = '定位：获取失败';
      return '未知城市';
    }
  }
  let currentCity = '未知城市';
  getLocationFromIP().then(city => currentCity = city);

  // BGM 播放
  function toggleBgm() {
    const bgm = document.getElementById('bgm');
    if (bgm.paused) {
      bgm.play();
    } else {
      bgm.pause();
    }
  }
  function changeBgm() {
    const selectedMusic = document.getElementById('bgmSelect').value;
    const bgm = document.getElementById('bgm');
    bgm.src = selectedMusic;
    bgm.play();
  }

  // 发表日记
  async function submitDiary() {
    const password = document.getElementById('password').value;
    const correctPassword = '200211';
    if (password !== correctPassword) {
      alert('密码错误！请重新输入');
      return;
    }
    const content = document.getElementById('diaryContent').value.trim();
    const mood = document.getElementById('mood').value;
    const city = currentCity;
    const files = document.getElementById('media').files;
    if (!content) return alert('先写点内容吧～');
    const Diary = AV.Object.extend('Diary');
    const diary = new Diary();
    diary.set('content', content);
    diary.set('mood', mood);
    diary.set('location', city);
    const acl = new AV.ACL();
    acl.setPublicReadAccess(true);
    diary.setACL(acl);
    // 上传图片/视频
    if (files.length) {
      const uploads = Array.from(files).map(f => {
        const avFile = new AV.File(f.name, f);
        return avFile.save();
      });
      const saved = await Promise.all(uploads);
      diary.set('mediaFiles', saved.map(f => ({
        url: f.url(), type: f.attributes.mime_type
      })));
    }
    diary.save().then(() => {
      alert('日记发表成功！');
      document.getElementById('diaryContent').value = '';
      document.getElementById('media').value = '';
      loadDiaries();
    }).catch(e => alert('保存失败：' + e.message));
  }

  // 加载评论
  async function getComments(diaryId) {
    const Comment = AV.Object.extend('Comment');
    const q = new AV.Query(Comment);
    q.equalTo('diaryId', diaryId);
    q.ascending('createdAt');
    const res = await q.find();
    return res.map(c => ({
      content: c.get('content'),
      time: c.createdAt.toLocaleString()
    }));
  }
  // 渲染评论
  async function renderComments(diaryId, container) {
    const comments = await getComments(diaryId);
    const listDiv = container.querySelector('.comments-list');
    if (comments.length === 0) {
      listDiv.innerHTML = '<div style="color:#aaa;font-size:14px;">暂无评论</div>';
    } else {
      listDiv.innerHTML = comments.map(c =>
        `<div style="margin-bottom:3px;padding:3px 0 0 0;border-bottom:1px solid #faf2f8;">
          <span style="color:#e84393;font-size:15px;">${escapeHtml(c.content)}</span>
          <span style="color:#aaa;font-size:12px;float:right;">${c.time}</span>
        </div>`
      ).join('');
    }
  }
  // 提交评论
  async function submitComment(diaryId, btn) {
    const form = btn.parentElement;
    const input = form.querySelector('input');
    const val = input.value.trim();
    if (!val) return;
    btn.disabled = true;
    const Comment = AV.Object.extend('Comment');
    const c = new Comment();
    c.set('diaryId', diaryId);
    c.set('content', val);
    await c.save();
    input.value = '';
    btn.disabled = false;
    // 刷新评论
    const container = form.parentElement;
    renderComments(diaryId, container);
  }
  // 防止XSS
  function escapeHtml(str) {
    return (str||'').replace(/[<>"'&]/g, s=>({"<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","&":"&amp;"}[s]));
  }

  // 加载历史日记（加评论功能）
  function loadDiaries() {
    const Diary = AV.Object.extend('Diary');
    const q = new AV.Query(Diary);
    q.descending('createdAt');
    q.limit(20);
    q.find().then(results => {
      const c = document.getElementById('diaryList');
      c.innerHTML = '';
      results.forEach(async d => {
        const content = d.get('content');
        const mood    = d.get('mood');
        const city    = d.get('location');
        const date    = d.createdAt.toLocaleString();
        const media   = d.get('mediaFiles') || [];
        const diaryId = d.id;
        let html = `<div class="diary-entry">
                      <div>${escapeHtml(content)}</div>`;
        if (media.length) {
          html += `<div class="media-container">`;
          media.forEach(f => {
            html += f.type.startsWith('image')
              ? `<img src="${f.url}" onclick="openLightbox('${f.url}')">`
              : `<video src="${f.url}" controls></video>`;
          });
          html += `</div>`;
        }
        html += `<div class="meta-info">${escapeHtml(mood)} | ${escapeHtml(city)} | ${date}</div>
                <div class="comments-container" data-diaryid="${diaryId}">
                  <div class="comments-list" style="margin-top:8px;"></div>
                  <div class="comment-form" style="display:flex;gap:6px;align-items:center;margin-top:5px;">
                    <input type="text" placeholder="写下你的评论..." maxlength="100" style="flex:1;padding:6px 10px;font-size:15px;border-radius:6px;border:1px solid #eee;">
                    <button type="button" style="background:#ff69b4;color:white;border:none;padding:6px 14px;border-radius:8px;font-size:14px;cursor:pointer;" onclick="submitComment('${diaryId}', this)">发送</button>
                  </div>
                </div>
                </div>`;
        c.insertAdjacentHTML('beforeend', html);
        // 渲染评论
        const entry = c.lastElementChild;
        renderComments(diaryId, entry.querySelector('.comments-container'));
      });
    });
  }

  // 大图放大
  function openLightbox(imageUrl) {
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = lightbox.querySelector('img');
    lightboxImage.src = imageUrl;
    lightbox.style.display = 'flex';
  }
  function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
  }

  window.onload = function() {
    changeBgm();
    loadDiaries();
  };
</script>
