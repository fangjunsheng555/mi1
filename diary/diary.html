<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>èœœè¯­æ—¥è®° ğŸŒ¸</title>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>
  <style>
    body {
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(135deg, #ffe4ec, #fff0f5, #fce4ec, #f3e5f5);
      background-size: 400% 400%;
      animation: gradientBG 12s ease infinite;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      color: #a0005b;
      text-align: center;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    textarea, select, input, button {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 16px;
    }
    button {
      background-color: #ff69b4;
      color: white;
      border: none;
      cursor: pointer;
      transition: transform .2s;
    }
    button:active {
      transform: scale(0.95);
    }
    .diary-entry {
      background: white;
      border-radius: 10px;
      padding: 12px;
      margin-top: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: left;
      margin-bottom: 20px;
    }
    .diary-entry > .diary-content {
      margin-bottom: 18px;
      white-space: pre-line;
    }
    .media-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
    }
    .media-container img {
      max-width: 22%;
      cursor: pointer;
      transition: transform 0.2s;
      margin-bottom: 8px;
    }
    .media-container img:hover {
      transform: scale(1.1);
    }
    .media-container video {
      max-width: 46%;
      margin-bottom: 8px;
    }
    .meta-info {
      font-size: 14px;
      color: #888;
      margin-top: 8px;
    }
    .like-btn {
      font-size: 18px;
      cursor: pointer;
      user-select: none;
      transition: color .18s;
    }
    .like-btn.liked { color: #ff69b4; }
    .comment-area {
      border-top: 1px dashed #eee;
      margin-top: 6px;
      padding-top: 8px;
    }
    .comment-list { margin-bottom: 10px; }
    .comment-item { font-size: 15px; margin-bottom: 7px;}
    .comment-item b { color: #d63384;}
    .comment-box input,
    .comment-box textarea {
      width: 48%;
      display: inline-block;
      vertical-align: middle;
      margin-bottom: 4px;
      margin-right: 2%;
    }
    .comment-box textarea { width: 49%; }
    .comment-box button {
      width: auto;
      padding: 5px 14px;
      margin-top: 0;
      margin-bottom: 0;
      font-size: 14px;
      background: #ff69b4;
      border-radius: 8px;
    }
    #bgm { display: none; }
    #lightbox {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center; align-items: center;
      z-index: 1000;
    }
    #lightbox img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
    }
    #musicCtrlBtn {
      display:inline-block;
      background: #fff0f6;
      color:#ff69b4;
      border:none;
      border-radius:50%;
      width:46px;height:46px;
      font-size:25px;
      margin-left:12px;
      vertical-align:middle;
      box-shadow: 0 1px 4px rgba(214,51,132,0.07);
      transition: background .18s;
    }
    #musicCtrlBtn:hover { background:#ffd1e6;}
  </style>
</head>
<body>
  <h2>ğŸŒ¸ èœœè¯­æ—¥è®° ğŸŒ¸</h2>
  <div style="margin-bottom:10px;">
    <label for="bgmSelect">é€‰æ‹©èƒŒæ™¯éŸ³ä¹ï¼š</label>
    <select id="bgmSelect">
      <option value="æµªæ¼«æ‰‹æœº.mp3">æµªæ¼«æ‰‹æœº</option>
      <option value="å¯çˆ±å¥³äºº.mp3">å¯çˆ±å¥³äºº</option>
      <option value="å›­æ¸¸ä¼š.mp3">å›­æ¸¸ä¼š</option>
    </select>
    <button id="musicCtrlBtn" onclick="toggleMusic()" title="æ’­æ”¾/æš‚åœ">
      â–¶ï¸
    </button>
  </div>
  <audio id="bgm" loop></audio>
  <input type="text" id="location" readonly placeholder="å®šä½ï¼šè·å–ä¸­â€¦">
  <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆèœœå„¿æˆ‘ä»¬è®¤è¯†çš„å¹´æœˆæ—¥ï¼‰" />
  <textarea id="diaryContent" rows="4" placeholder="ä»Šå¤©æƒ³è®°å½•äº›ä»€ä¹ˆå‘¢ï¼Ÿ"></textarea>
  <select id="mood">
    <option>ğŸ˜Š å¼€å¿ƒ</option>
    <option>ğŸ˜¢ éš¾è¿‡</option>
    <option>ğŸ¥° ç”œèœœ</option>
    <option>ğŸ˜¡ ç”Ÿæ°”</option>
    <option>ğŸ˜ ä¸€èˆ¬</option>
  </select>
  <input type="file" id="media" accept="image/*,video/*" multiple>
  <button onclick="submitDiary()">å‘è¡¨æ—¥è®° ğŸŒ¸</button>
  <div id="historyTitle" style="margin-top:30px;font-size:20px;color:#d63384;text-shadow:1px 1px 2px #ffc0cb;">ğŸ“œ å†å²æ—¥è®°</div>
  <div id="diaryList"></div>
  <!-- æ”¾å¤§å›¾å¼¹çª— -->
  <div id="lightbox" onclick="closeLightbox()">
    <img src="" alt="æ”¾å¤§å›¾" />
  </div>
<script>
  // LeanCloudåˆå§‹åŒ–
  AV.init({
    appId: 'bxR762L3dDWFiyX2u7nsxLHV-gzGzoHsz',
    appKey: 'uVCOuieZ3JnX7zH8BQdLSzoF',
    serverURL: 'https://bxr762l3.lc-cn-n1-shared.com'
  });

  // å®šä½
  async function getLocationFromIP() {
    try {
      const response = await fetch('https://ipapi.co/json/');
      const data = await response.json();
      const city = data.city || 'æœªçŸ¥åŸå¸‚';
      document.getElementById('location').value = 'å®šä½ï¼š' + city;
      return city;
    } catch (error) {
      document.getElementById('location').value = 'å®šä½ï¼šè·å–å¤±è´¥';
      return 'æœªçŸ¥åŸå¸‚';
    }
  }
  let currentCity = 'æœªçŸ¥åŸå¸‚';
  getLocationFromIP().then(city => currentCity = city);

  // ======= BGM è‡ªåŠ¨æ’­æ”¾/åˆ‡æ­Œè‡ªåŠ¨æ’­æ”¾/æ’­æ”¾æš‚åœæŒ‰é’®åŒæ­¥ =======
  const bgm = document.getElementById('bgm');
  const bgmSelect = document.getElementById('bgmSelect');
  const musicCtrlBtn = document.getElementById('musicCtrlBtn');

  // æ­Œæ›²åˆ‡æ¢è‡ªåŠ¨æ’­æ”¾
  bgmSelect.onchange = function(){
    bgm.src = this.value;
    bgm.play();
  };
  // æ’­æ”¾æš‚åœåˆ‡æ¢
  function toggleMusic(){
    if(bgm.paused){
      bgm.play();
    }else{
      bgm.pause();
    }
  }
  // æŒ‰é’®çŠ¶æ€åŒæ­¥
  function updateMusicBtn() {
    musicCtrlBtn.innerText = bgm.paused ? "â–¶ï¸" : "â¸";
  }
  bgm.onplay = updateMusicBtn;
  bgm.onpause = updateMusicBtn;

  // è‡ªåŠ¨æ’­æ”¾
  function tryAutoPlayMusic(){
    bgm.src = bgmSelect.value;
    bgm.style.display = 'block';
    bgm.play().catch(()=>{});
  }
  // è‡ªåŠ¨æ’­æ”¾å…¼å®¹ï¼ˆç”¨æˆ·é¦–æ¬¡ç‚¹å‡»é¡µé¢ï¼‰
  document.body.addEventListener('pointerdown', function firstPlay(){
    tryAutoPlayMusic();
    document.body.removeEventListener('pointerdown', firstPlay);
  });
  window.onload = function() {
    tryAutoPlayMusic();
    loadDiaries();
  };

  // ========== æ—¥è®°æäº¤ ==========
  async function submitDiary() {
    const password = document.getElementById('password').value;
    const correctPassword = '200211';
    if (password !== correctPassword) {
      alert('å¯†ç é”™è¯¯ï¼è¯·é‡æ–°è¾“å…¥');
      return;
    }
    const content = document.getElementById('diaryContent').value.trim();
    const mood    = document.getElementById('mood').value;
    const city    = currentCity;
    const files   = document.getElementById('media').files;
    if (!content) return alert('å…ˆå†™ç‚¹å†…å®¹å§ï½');
    const Diary = AV.Object.extend('Diary');
    const diary = new Diary();
    diary.set('content', content);
    diary.set('mood', mood);
    diary.set('location', city);
    const acl = new AV.ACL();
    acl.setPublicReadAccess(true);
    diary.setACL(acl);
    if (files.length) {
      const uploads = Array.from(files).map(f => {
        const avFile = new AV.File(f.name, f);
        return avFile.save();
      });
      const saved = await Promise.all(uploads);
      diary.set('mediaFiles', saved.map(f => ({
        url: f.url(), type: f.attributes.mime_type
      })));
    }
    diary.set('likes', 0);
    diary.save().then(() => {
      alert('æ—¥è®°å‘è¡¨æˆåŠŸï¼');
      document.getElementById('diaryContent').value = '';
      document.getElementById('media').value = '';
      loadDiaries();
    }).catch(e => alert('ä¿å­˜å¤±è´¥ï¼š' + e.message));
  }

  // ========== ç‚¹èµ/è¯„è®ºç›¸å…³ ==========
  // æ¯äººæ¯æ¡æ—¥è®°åªèƒ½ç‚¹ä¸€æ¬¡ï¼ˆæœ¬åœ°localStorageåˆ¤å®šï¼‰
  function toggleLike(diaryId, dom) {
    let liked = JSON.parse(localStorage.getItem('diaryLiked') || '[]');
    if (liked.includes(diaryId)) {
      alert('ä½ å·²ç»ç‚¹è¿‡èµå•¦~');
      return;
    }
    const Diary = AV.Object.extend('Diary');
    const q = new AV.Query(Diary);
    q.get(diaryId).then(obj => {
      let likes = obj.get('likes') || 0;
      obj.set('likes', likes + 1);
      obj.save().then(() => {
        liked.push(diaryId);
        localStorage.setItem('diaryLiked', JSON.stringify(liked));
        dom.classList.add('liked');
        dom.querySelector('.like-count').innerText = likes + 1;
      });
    });
  }
  // è¯„è®º
  async function submitComment(diaryId, nickId, textId, listId) {
    let text = document.getElementById(textId).value.trim();
    let nick = document.getElementById(nickId).value.trim() || "åŒ¿å";
    if (!text) return alert("è¯·è¾“å…¥è¯„è®ºå†…å®¹~");
    const Comment = AV.Object.extend('Comment');
    const comment = new Comment();
    comment.set('diaryId', diaryId);
    comment.set('nick', nick);
    comment.set('content', text);
    await comment.save();
    document.getElementById(textId).value = '';
    loadComments(diaryId, listId);
  }
  function loadComments(diaryId, listId) {
    const Comment = AV.Object.extend('Comment');
    const q = new AV.Query(Comment);
    q.equalTo('diaryId', diaryId);
    q.ascending('createdAt');
    q.limit(100);
    q.find().then(results => {
      const c = document.getElementById(listId);
      c.innerHTML = results.length
        ? results.map(x => `<div class="comment-item"><b>${x.get('nick') || "åŒ¿å"}ï¼š</b>${x.get('content')}</div>`).join('')
        : `<div style="color:#aaa;">è¿˜æ²¡æœ‰è¯„è®º~</div>`;
    });
  }

  // ========== å†å²æ—¥è®°åŠ è½½  ==========
  function loadDiaries() {
    const Diary = AV.Object.extend('Diary');
    const q     = new AV.Query(Diary);
    q.descending('createdAt');
    q.limit(100); // ä¸€æ¬¡æœ€å¤š100æ¡ï¼Œå¦‚éœ€æ›´å¤šåšåˆ†é¡µ
    q.find().then(results => {
      const c = document.getElementById('diaryList');
      c.innerHTML = '';
      let likedList = JSON.parse(localStorage.getItem('diaryLiked') || '[]');
      results.forEach((d,i) => {
        const content = d.get('content');
        const mood    = d.get('mood');
        const city    = d.get('location');
        const date    = d.createdAt.toLocaleString();
        const media   = d.get('mediaFiles') || [];
        const likes   = d.get('likes') || 0;
        const diaryId = d.id;
        // æ¯æ¡è¯„è®ºåŒºç”¨å”¯ä¸€IDåŒºåˆ†
        let commentNickId = `commentNick${diaryId}`;
        let commentTextId = `commentText${diaryId}`;
        let commentListId = `commentList${diaryId}`;
        let html = `<div class="diary-entry">
          <div class="diary-content">${content}</div>`;
        // å›¾ç‰‡
        if (media.length) {
          html += `<div class="media-container">`;
          media.forEach(f => {
            html += f.type.startsWith('image')
              ? `<img src="${f.url}" onclick="openLightbox('${f.url}')">`
              : `<video src="${f.url}" controls></video>`;
          });
          html += `</div>`;
        }
        // ç‚¹èµ+è¯„è®ºè¾“å…¥+è¯„è®ºåŒº
        html += `
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:6px;">
          <span class="like-btn${likedList.includes(diaryId)?' liked':''}" onclick="toggleLike('${diaryId}', this)">
            ğŸ‘ <span class="like-count">${likes}</span>
          </span>
          <span style="color:#d63384;">ğŸ’¬ è¯„è®º</span>
        </div>
        <div class="comment-area">
          <div class="comment-list" id="${commentListId}" style="margin-bottom:6px;"></div>
          <div class="comment-box">
            <input type="text" id="${commentNickId}" placeholder="æ˜µç§°(å¯ç©º)" maxlength="12">
            <textarea rows="1" id="${commentTextId}" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." style="resize:none;height:28px;"></textarea>
            <button onclick="submitComment('${diaryId}','${commentNickId}','${commentTextId}','${commentListId}')">å‘è¡¨</button>
          </div>
        </div>
        <div class="meta-info">${mood} | ${city} | ${date}</div>
        </div>`;
        c.insertAdjacentHTML('beforeend', html);
        // åŠ è½½è¯¥æ—¥è®°çš„è¯„è®º
        setTimeout(()=>loadComments(diaryId, commentListId),0);
      });
    });
  }
  // å›¾ç‰‡æ”¾å¤§
  function openLightbox(imageUrl) {
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = lightbox.querySelector('img');
    lightboxImage.src =
