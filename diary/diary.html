<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>èœœè¯­æ—¥è®° ğŸŒ¸</title>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>
  <style>
    body {
      position: relative;
      overflow-x: hidden;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(135deg, #ffe4ec, #fff0f5, #fce4ec, #f3e5f5);
      background-size: 400% 400%;
      animation: gradientBG 12s ease infinite;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      color: #a0005b;
      text-align: center;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    textarea, select, input, button {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 16px;
    }
    button {
      background-color: #ff69b4;
      color: white;
      border: none;
      cursor: pointer;
      transition: transform .2s;
    }
    button:active {
      transform: scale(0.95);
    }
    .diary-entry {
      background: white;
      border-radius: 10px;
      padding: 12px;
      margin-top: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: left;
      margin-bottom: 20px;
    }
    .diary-entry > div:first-child {
      margin-bottom: 20px; /* æ–‡å­—å’Œå›¾ç‰‡ä¹‹é—´çš„é—´éš” */
    }
    .media-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .media-container img {
      max-width: 22%;
      cursor: pointer;
      transition: transform 0.2s;
      margin-bottom: 8px;
    }
    .media-container img:hover {
      transform: scale(1.1);
    }
    .media-container video {
      max-width: 46%;
      margin-bottom: 8px;
    }
    .meta-info {
      font-size: 14px;
      color: #888;
      margin-top: 8px;
    }
    #bgm { display: none; }
    #lightbox {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center; align-items: center;
      z-index: 1000;
    }
    #lightbox img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
    }
    /* è¯„è®ºå¼¹çª— */
    #commentModal {
      display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,.38);
      align-items: center; justify-content: center;
      z-index: 1200;
    }
    #commentModal .modal-box {
      background: #fff; padding: 20px 18px 16px 18px;
      border-radius: 14px; min-width: 320px; max-width: 94vw;
      box-shadow: 0 8px 32px rgba(0,0,0,0.16);
      animation: modalFadeIn .2s;
    }
    @keyframes modalFadeIn { from { transform: translateY(30px); opacity: 0; } to { transform: none; opacity: 1; } }
    #commentList { max-height: 180px; overflow-y: auto; margin-bottom: 12px; }
    #commentList .one-comment { font-size: 15px; margin-bottom: 8px; text-align:left; }
    #commentList .one-comment b { color: #d63384;}
  </style>
</head>
<body>
  <h2>ğŸŒ¸ èœœè¯­æ—¥è®° ğŸŒ¸</h2>
  <!-- éŸ³ä¹é€‰æ‹© -->
  <label for="bgmSelect">é€‰æ‹©èƒŒæ™¯éŸ³ä¹ï¼š</label>
  <select id="bgmSelect" onchange="changeBgm()">
    <option value="æµªæ¼«æ‰‹æœº.mp3">æµªæ¼«æ‰‹æœº</option>
    <option value="å¯çˆ±å¥³äºº.mp3">å¯çˆ±å¥³äºº</option>
    <option value="å›­æ¸¸ä¼š.mp3">å›­æ¸¸ä¼š</option>
  </select>
  <button onclick="toggleBgm()" id="playBtn">ç‚¹å‡»æ’­æ”¾/æš‚åœèƒŒæ™¯éŸ³ä¹</button>
  <audio id="bgm" loop></audio>
  <input type="text" id="location" readonly placeholder="å®šä½ï¼šè·å–ä¸­â€¦">
  <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆèœœå„¿æˆ‘ä»¬è®¤è¯†çš„å¹´æœˆæ—¥ï¼‰" />
  <textarea id="diaryContent" rows="4" placeholder="ä»Šå¤©æƒ³è®°å½•äº›ä»€ä¹ˆå‘¢ï¼Ÿ"></textarea>
  <select id="mood">
    <option>ğŸ˜Š å¼€å¿ƒ</option>
    <option>ğŸ˜¢ éš¾è¿‡</option>
    <option>ğŸ¥° ç”œèœœ</option>
    <option>ğŸ˜¡ ç”Ÿæ°”</option>
    <option>ğŸ˜ ä¸€èˆ¬</option>
  </select>
  <input type="file" id="media" accept="image/*,video/*" multiple>
  <button onclick="submitDiary()">å‘è¡¨æ—¥è®° ğŸŒ¸</button>
  <div id="historyTitle" style="margin-top:30px;font-size:20px;color:#d63384;text-shadow:1px 1px 2px #ffc0cb;">ğŸ“œ å†å²æ—¥è®°</div>
  <div id="diaryList"></div>

  <!-- è¯„è®ºå¼¹çª— -->
  <div id="commentModal">
    <div class="modal-box">
      <h4 style="margin-top:0;">è¯„è®ºåŒº</h4>
      <div id="commentList"></div>
      <input type="text" id="commentNick" placeholder="æ˜µç§°(å¯ç©º)" maxlength="12" style="width:100%;margin-bottom:8px;">
      <textarea id="commentText" rows="2" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." style="width:100%;"></textarea>
      <div style="margin-top:10px;">
        <button onclick="submitComment()">å‘è¡¨è¯„è®º</button>
        <button onclick="closeCommentModal()" style="margin-left:8px;">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- æ”¾å¤§å›¾å¼¹çª— -->
  <div id="lightbox" onclick="closeLightbox()">
    <img src="" alt="æ”¾å¤§å›¾" />
  </div>

<script>
  // LeanCloudåˆå§‹åŒ–
  AV.init({
    appId: 'bxR762L3dDWFiyX2u7nsxLHV-gzGzoHsz',
    appKey: 'uVCOuieZ3JnX7zH8BQdLSzoF',
    serverURL: 'https://bxr762l3.lc-cn-n1-shared.com'
  });

  // å®šä½
  async function getLocationFromIP() {
    try {
      const response = await fetch('https://ipapi.co/json/');
      const data = await response.json();
      const city = data.city || 'æœªçŸ¥åŸå¸‚';
      document.getElementById('location').value = 'å®šä½ï¼š' + city;
      return city;
    } catch (error) {
      document.getElementById('location').value = 'å®šä½ï¼šè·å–å¤±è´¥';
      return 'æœªçŸ¥åŸå¸‚';
    }
  }
  let currentCity = 'æœªçŸ¥åŸå¸‚';
  getLocationFromIP().then(city => currentCity = city);

  // BGMç›¸å…³
  function changeBgm() {
    const bgm = document.getElementById('bgm');
    const selectedMusic = document.getElementById('bgmSelect').value;
    bgm.src = selectedMusic;
    bgm.load();
  }
  function toggleBgm() {
    const bgm = document.getElementById('bgm');
    bgm.style.display = 'block';
    if (bgm.paused) {
      bgm.play();
      document.getElementById('playBtn').innerText = "ç‚¹å‡»æš‚åœèƒŒæ™¯éŸ³ä¹";
    } else {
      bgm.pause();
      document.getElementById('playBtn').innerText = "ç‚¹å‡»æ’­æ”¾èƒŒæ™¯éŸ³ä¹";
    }
  }
  // è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªéŸ³ä¹
  window.onload = function() {
    changeBgm();
    loadDiaries();
  };

  // æ—¥è®°æäº¤
  async function submitDiary() {
    const password = document.getElementById('password').value;
    const correctPassword = '200211';
    if (password !== correctPassword) {
      alert('å¯†ç é”™è¯¯ï¼è¯·é‡æ–°è¾“å…¥');
      return;
    }
    const content = document.getElementById('diaryContent').value.trim();
    const mood    = document.getElementById('mood').value;
    const city    = currentCity;
    const files   = document.getElementById('media').files;
    if (!content) return alert('å…ˆå†™ç‚¹å†…å®¹å§ï½');
    const Diary = AV.Object.extend('Diary');
    const diary = new Diary();
    diary.set('content', content);
    diary.set('mood', mood);
    diary.set('location', city);
    const acl = new AV.ACL();
    acl.setPublicReadAccess(true);
    diary.setACL(acl);

    // ä¸Šä¼ å›¾ç‰‡/è§†é¢‘
    if (files.length) {
      const uploads = Array.from(files).map(f => {
        const avFile = new AV.File(f.name, f);
        return avFile.save();
      });
      const saved = await Promise.all(uploads);
      diary.set('mediaFiles', saved.map(f => ({
        url: f.url(), type: f.attributes.mime_type
      })));
    }
    diary.set('likes', 0);
    diary.save().then(() => {
      alert('æ—¥è®°å‘è¡¨æˆåŠŸï¼');
      document.getElementById('diaryContent').value = '';
      document.getElementById('media').value = '';
      loadDiaries();
    }).catch(e => alert('ä¿å­˜å¤±è´¥ï¼š' + e.message));
  }

  // ----------- ç‚¹èµä¸è¯„è®ºåŠŸèƒ½ç›¸å…³ -----------
  let commentDiaryId = "";
  function showCommentModal(diaryId) {
    commentDiaryId = diaryId;
    document.getElementById('commentText').value = '';
    document.getElementById('commentNick').value = '';
    document.getElementById('commentModal').style.display = 'flex';
    loadComments(diaryId);
  }
  function closeCommentModal() {
    document.getElementById('commentModal').style.display = 'none';
  }
  function submitComment() {
    let text = document.getElementById('commentText').value.trim();
    let nick = document.getElementById('commentNick').value.trim() || "åŒ¿å";
    if (!text) return alert("è¯·è¾“å…¥è¯„è®ºå†…å®¹~");
    const Comment = AV.Object.extend('Comment');
    const comment = new Comment();
    comment.set('diaryId', commentDiaryId);
    comment.set('nick', nick);
    comment.set('content', text);
    comment.save().then(() => {
      document.getElementById('commentText').value = '';
      loadComments(commentDiaryId);
    });
  }
  function loadComments(diaryId) {
    const Comment = AV.Object.extend('Comment');
    const q = new AV.Query(Comment);
    q.equalTo('diaryId', diaryId);
    q.ascending('createdAt');
    q.limit(100);
    q.find().then(results => {
      const c = document.getElementById('commentList');
      c.innerHTML = results.length
        ? results.map(x => `<div class="one-comment"><b>${x.get('nick') || "åŒ¿å"}ï¼š</b>${x.get('content')}</div>`).join('')
        : `<div style="color:#aaa;">è¿˜æ²¡æœ‰è¯„è®º~</div>`;
    });
  }
  // ç‚¹èµï¼Œæ¯äººæ¯æ¡æ—¥è®°åªèƒ½ç‚¹ä¸€æ¬¡ï¼ˆæœ¬åœ°localStorageåˆ¤å®šï¼‰
  function toggleLike(diaryId, dom) {
    let liked = JSON.parse(localStorage.getItem('diaryLiked') || '[]');
    if (liked.includes(diaryId)) {
      alert('ä½ å·²ç»ç‚¹è¿‡èµå•¦~');
      return;
    }
    const Diary = AV.Object.extend('Diary');
    const q = new AV.Query(Diary);
    q.get(diaryId).then(obj => {
      let likes = obj.get('likes') || 0;
      obj.set('likes', likes + 1);
      obj.save().then(() => {
        liked.push(diaryId);
        localStorage.setItem('diaryLiked', JSON.stringify(liked));
        dom.querySelector('.like-count').innerText = likes + 1;
        dom.querySelector('.like-btn').style.color = '#ff69b4';
      });
    });
  }

  // ----------- å†å²æ—¥è®°åŠ è½½ -----------
  function loadDiaries() {
    const Diary = AV.Object.extend('Diary');
    const q     = new AV.Query(Diary);
    q.descending('createdAt');
    q.limit(20);
    q.find().then(results => {
      const c = document.getElementById('diaryList');
      c.innerHTML = '';
      let likedList = JSON.parse(localStorage.getItem('diaryLiked') || '[]');
      results.forEach(d => {
        const content = d.get('content');
        const mood    = d.get('mood');
        const city    = d.get('location');
        const date    = d.createdAt.toLocaleString();
        const media   = d.get('mediaFiles') || [];
        const likes   = d.get('likes') || 0;
        const diaryId = d.id;
        let html = `<div class="diary-entry">
          <div>${content}</div>`;

        // å›¾ç‰‡
        if (media.length) {
          html += `<div class="media-container">`;
          media.forEach(f => {
            html += f.type.startsWith('image')
              ? `<img src="${f.url}" onclick="openLightbox('${f.url}')">`
              : `<video src="${f.url}" controls></video>`;
          });
          html += `</div>`;
        }

        // ç‚¹èµ+è¯„è®º
        html += `
          <div style="display:flex;align-items:center;gap:18px;margin-bottom:10px;">
            <span style="cursor:pointer;display:flex;align-items:center;" class="like-dom" onclick="toggleLike('${diaryId}', this)">
              <span class="like-btn" style="font-size:18px;${likedList.includes(diaryId)?'color:#ff69b4':''}">ğŸ‘</span>
              <span class="like-count" style="margin-left:3px;">${likes}</span>
            </span>
            <span style="cursor:pointer;color:#d63384;" onclick="showCommentModal('${diaryId}')">ğŸ’¬ è¯„è®º</span>
          </div>
        `;
        html += `<div class="meta-info">${mood} | ${city} | ${date}</div>
        </div>`;
        c.insertAdjacentHTML('beforeend', html);
      });
    });
  }

  // ----------- å›¾ç‰‡æ”¾å¤§åŠŸèƒ½ -----------
  function openLightbox(imageUrl) {
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = lightbox.querySelector('img');
    lightboxImage.src = imageUrl;
    lightbox.style.display = 'flex';
  }
  function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
  }
</script>
</body>
</html>
